@page "/root/userManage/createUser"

@using AutoMapper
@using MediatR
@using Questionnaire.Blazor.Models
@using Questionnaire.Domain.Entities.Identity
@using Questionnaire.Infrastructure.Commands.Requests.Identity
@using Questionnaire.Infrastructure.Queries.Requests.Identity
@using Questionnaire.Infrastructure.Conventions;

<EditForm Model=user OnValidSubmit=Send>
    <ValidationSummary />
    <DataAnnotationsValidator />
    <p class="text-danger">@message</p>
    <div class="form-group">
        <label>Почта</label>
        <InputText type="email" @bind-Value=user.Email class="form-control" />
    </div>

    <div class="form-group">
        <label>Пароль</label>
        <InputText type="password" @bind-Value=user.Password class="form-control" />
    </div>

    <div class="form-group">
        <label>Роль</label>
        <InputSelect @bind-Value=user.Role class="custom-select">
            <option value=@RoleConstants.Questioned>Опрашиваемый</option>
            <option value="@RoleConstants.Admin">Администратор</option>
        </InputSelect>
    </div>

    <button class="btn btn-success">Отправить</button>
</EditForm>

@code {
    private string message;
    private UserModel user = new()
    {
        Role = "interviewee",
    };

    [Inject]
    private IMapper Mapper { get; set; }

    [Inject]
    private IMediator Mediator { get; set; }

    private async Task Send()
    {
        if (await Mediator.Send(new EmailIsBusyQuery(user.Email)))
        {
            message = "Эта почта уже занята";
        }
        else
        {
            var applicationUser = Mapper.Map<ApplicationUser>(user);
            await Mediator.Send(new CreateUserCommand(applicationUser, user.Password, user.Role));

            message = "Аккаунт успешно создан";
        }
    }
}
