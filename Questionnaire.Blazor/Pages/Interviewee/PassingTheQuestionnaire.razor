@page "/interviewee/passingTheQuestionnaire/{questionnaireId:int}"

@using AutoMapper
@using MediatR
@using Questionnaire.Blazor.Models
@using Questionnaire.Blazor.Models.Questions
@using Questionnaire.Domain.Entities
@using Questionnaire.Infrastructure.Commands.Requests.Answers
@using Questionnaire.Infrastructure.Queries.Requests.Properties
@using Questionnaire.Infrastructure.Queries.Requests.UniversalQueries

<h3>@questionnaire.DisplayName</h3>
<EditForm Model=questionnaire OnValidSubmit=Send>
    @foreach (var questionAnswer in questionsAnswers)
    {
        <QuestionDisplay Question=questionAnswer.Key Answer=questionAnswer.Value />
    }
    <button class="btn btn-success">Отправить</button>
</EditForm>

@code {
    private QuestionnaireModel questionnaire = new();
    private Dictionary<QuestionModel, AnswerModel> questionsAnswers = new();

    [Parameter]
    public int QuestionnaireId { get; set; }

    [Inject]
    private IMapper Mapper { get; set; }

    [Inject]
    private IMediator Mediator { get; set; }

    protected async override Task OnInitializedAsync()
    {
        var questionnaireEntity = await Mediator.Send(new GetEntityQuery<QuestionnaireEntity>(QuestionnaireId));
        questionnaire = Mapper.Map<QuestionnaireModel>(questionnaireEntity);

        var propertyAnswerPairs = await Mediator.Send(new GetPropertyAnswerPairsQuery(QuestionnaireId, 6));
        questionsAnswers = Mapper.Map<Dictionary<QuestionModel, AnswerModel>>(propertyAnswerPairs);
    }

    private async Task Send()
    {
        var answers = Mapper.Map<IEnumerable<AnswerEntity>>(questionsAnswers.Values.AsEnumerable());
        await Mediator.Send(new CreateAnswersCommand(answers));
    }
}
